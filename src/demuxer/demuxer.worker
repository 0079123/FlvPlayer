"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}function _instanceof(e,r){return null!=r&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](e):e instanceof r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,r){if(!_instanceof(e,r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){return!r||"object"!==_typeof(r)&&"function"!=typeof r?_assertThisInitialized(e):r}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&_setPrototypeOf(e,r)}function _wrapNativeSuper(e){var r="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(t,e)})(e)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _construct(e,r,t){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(e,r,t){var n=[null];n.push.apply(n,r);var a=new(Function.bind.apply(e,n));return t&&_setPrototypeOf(a,t.prototype),a}).apply(null,arguments)}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _setPrototypeOf(e,r){return(_setPrototypeOf=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var FlvPlayerError=function(e){function r(e){var t;return _classCallCheck(this,r),(t=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,e))).name="FlvPlayerError",t}return _inherits(r,_wrapNativeSuper(Error)),r}(),debug={warn:function(e){if(!e){for(var r,t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];(r=console).warn.apply(r,n)}},error:function(e,r){if(!e)throw new FlvPlayerError(r)}};function mergeBuffer(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n=r[0].constructor;return r.reduce(function(e,r){var t=new n((0|e.byteLength)+(0|r.byteLength));return t.set(e,0),t.set(r,0|e.byteLength),t},new n)}function readBufferSum(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e.reduce(function(t,n,a){return t+(r?n:n-128)*256**(e.length-a-1)},0)}function readString(e){var r;return(r=String.fromCharCode).call.apply(r,[String].concat(_toConsumableArray(e)))}function readBuffer(e){var r=0;function t(n){for(var a=new Uint8Array(n),o=0;o<n;o+=1)a[o]=e[r],r+=1;return t.index=r,a}return t.index=0,t}function readDouble(e){var r=new DataView(new ArrayBuffer(e.length));return e.forEach(function(e,t){r.setUint8(t,e)}),r.getFloat64(0)}function readBoolean(e){return 0!==e[0]}var index=0,header=null,uint8=new Uint8Array,scripMeta=null,AudioSpecificConfig=null,AVCDecoderConfigurationRecord=null,nalStart=new Uint8Array([0,0,0,1]);function readable(e){return uint8.length-index>=e}function read(e){for(var r=new Uint8Array(e),t=0;t<e;t+=1)r[t]=uint8[index],index+=1;return r}function demuxerScripTag(e){var r=readBuffer(e.body),t=Object.create(null),n=Object.create(null);function a(e){var t=null;if(void 0!==e)switch(e){case 0:t=readDouble(r(8));break;case 1:t=readBoolean(r(1));break;case 2:var n=readBufferSum(r(2));t=readString(r(n));break;case 3:t=Object.create(null);for(var o=-1;9!==o;){var i=readBufferSum(r(2)),u=readString(r(i)),c=r(1)[0];u&&(t[u]=a(c)),o=c}break;case 5:t=null;break;case 6:t=void 0;break;case 7:t="Reference #".concat(r.index),r(2);break;case 8:t=Object.create(null);for(var f=-1;9!==f;){var d=readBufferSum(r(2)),s=readString(r(d)),l=r(1)[0];s&&(t[s]=a(l)),f=l}break;case 10:var g=readBufferSum(r(4));t=[];for(var p=0;p<g;p+=1){var y=r(1)[0];t.push(a(y))}break;case 11:t=readDouble(r(2));break;case 12:var b=readBufferSum(r(4));t=readString(r(b));break;default:debug.error(!1,"AMF: Unknown metaData type: ".concat(e))}return t}for(t.type=r(1)[0],debug.error(2===t.type,"AMF: [amf1] type expect 2, but got ".concat(t.type)),t.size=readBufferSum(r(2)),t.string=readString(r(t.size)),n.type=r(1)[0],debug.error(8===n.type||3===n.type,"AMF: [amf2] type expect 8 or 3, but got ".concat(n.type)),n.size=readBufferSum(r(4)),n.metaData=Object.create(null);r.index<e.body.length;){var o=readBufferSum(r(2)),i=readString(r(o)),u=r(1)[0];i&&(n.metaData[i]=a(u))}debug.error(r.index===e.body.length,"AMF: Seems to be incompletely parsed"),debug.error(n.size===Object.keys(n.metaData).length,"AMF: [amf2] length does not match"),postMessage({type:"scripMeta",data:scripMeta={amf1:t,amf2:n}})}function demuxerVideoTag(e){debug.error(e.body.length>1,"Invalid video packet");var r={frameType:(240&e.body[0])>>4,codecID:15&e.body[0]};debug.error(7===r.codecID,"[videoTrack] Unsupported codec in video frame: ".concat(r.codecID));var t=e.body.slice(1,5);debug.error(t.length>=4,"[H264] Invalid AVC packet, missing AVCPacketType or/and CompositionTime");var n=new DataView(t.buffer),a=n.getUint8(0),o=((16777215&n.getUint32(0))<<8>>8)+e.timestamp,i=e.body.subarray(5);if(0===a){debug.warn(!AVCDecoderConfigurationRecord,"[h264] Find another one AVCDecoderConfigurationRecord"),debug.error(i.length>=7,"[H264] AVCDecoderConfigurationRecord parse length is not enough");var u=readBuffer(i),c={};c.configurationVersion=u(1)[0],debug.error(1===c.configurationVersion,"[H264] Invalid configurationVersion: ".concat(c.configurationVersion)),c.AVCProfileIndication=u(1)[0],debug.error(0!==c.AVCProfileIndication,"[H264] Invalid AVCProfileIndication: ".concat(c.AVCProfileIndication)),c.profile_compatibility=u(1)[0],c.AVCLevelIndication=u(1)[0],c.lengthSizeMinusOne=1+(3&u(1)[0]),debug.error(4===c.lengthSizeMinusOne||3!==c.lengthSizeMinusOne,"[H264] Invalid lengthSizeMinusOne: ".concat(c.lengthSizeMinusOne)),c.numOfSequenceParameterSets=31&u(1)[0],debug.error(0!==c.numOfSequenceParameterSets,"[H264] Invalid numOfSequenceParameterSets: ".concat(c.numOfSequenceParameterSets)),debug.warn(1===c.numOfSequenceParameterSets,"[H264] Strange numOfSequenceParameterSets: ".concat(c.numOfSequenceParameterSets));for(var f=0;f<c.numOfSequenceParameterSets;f+=1)if(c.sequenceParameterSetLength=readBufferSum(u(2)),c.sequenceParameterSetLength>0){var d=u(c.sequenceParameterSetLength);postMessage({type:"videoData",data:mergeBuffer(nalStart,d)})}c.numOfPictureParameterSets=u(1)[0],debug.error(0!==c.numOfPictureParameterSets,"[H264] Invalid numOfPictureParameterSets: ".concat(c.numOfPictureParameterSets)),debug.warn(1===c.numOfPictureParameterSets,"[H264] Strange numOfPictureParameterSets: ".concat(c.numOfPictureParameterSets));for(var s=0;s<c.numOfPictureParameterSets;s+=1)if(c.pictureParameterSetLength=readBufferSum(u(2)),c.pictureParameterSetLength>0){var l=u(c.pictureParameterSetLength);postMessage({type:"videoData",data:mergeBuffer(nalStart,l)})}AVCDecoderConfigurationRecord=c,postMessage({type:"AVCDecoderConfigurationRecord",data:c})}else if(1===a)for(var g=AVCDecoderConfigurationRecord.lengthSizeMinusOne,p=readBuffer(i);p.index<i.length;){var y=readBufferSum(p(g));postMessage({type:"videoData",data:mergeBuffer(nalStart,p(y)),timestamp:o})}else debug.error(2===a,"[H264] Invalid video packet type ".concat(a))}function demuxerAudioTag(e){debug.error(e.body.length>1,"Invalid audio packet");var r={soundFormat:(240&e.body[0])>>4,soundRate:(12&e.body[0])>>2,soundSize:(2&e.body[0])>>1,soundType:(1&e.body[0])>>0};debug.error(10===r.soundFormat,"[audioTrack] unsupported audio format: ".concat(r.soundFormat));var t=e.body.subarray(1);if(0===t[0]){var n=t.subarray(1);debug.warn(!AudioSpecificConfig,"[aac] Find another one AudioSpecificConfig"),debug.error(n.length>=2,"[aac] AudioSpecificConfig parse length is not enough");var a={};a.audioObjectType=(248&n[0])>>3,a.samplingFrequencyIndex=((7&n[0])<<1)+((128&n[1])>>7&1),a.channelConfiguration=(127&n[1])>>3,AudioSpecificConfig=a,postMessage({type:"AudioSpecificConfig",data:a})}else{var o=AudioSpecificConfig,i=o.audioObjectType,u=o.samplingFrequencyIndex,c=o.channelConfiguration,f=e.dataSize-2+7,d=new Uint8Array(7);d[0]=255,d[1]=240,d[1]|=0,d[1]|=0,d[1]|=1,d[2]=i-1<<6,d[2]|=(15&u)<<2,d[2]|=0,d[2]|=(4&c)>>2,d[3]=(3&c)<<6,d[3]|=0,d[3]|=0,d[3]|=0,d[3]|=0,d[3]|=(6144&f)>>11,d[4]=(2040&f)>>3,d[5]=(7&f)<<5,d[5]|=31,d[6]=252;var s=e.body.subarray(2);postMessage({type:"audioData",data:mergeBuffer(d,s),timestamp:e.timestamp})}}onmessage=function(e){if(uint8=mergeBuffer(uint8,e.data),!header&&readable(13)){(header=Object.create(null)).signature=readString(read(3)),header.version=read(1)[0],debug.error("FLV"===header.signature&&1===header.version,"FLV header not found"),header.flags=read(1)[0],console.log(header.flags),debug.error(5===header.flags||1===header.flags,"FLV header flags not found video"),1===header.flags&&postMessage({type:"noAudio"}),header.headersize=readBufferSum(read(4));var r=readBufferSum(read(4));debug.error(0===r,"PrevTagSize0 should be equal to 0, but got ".concat(r)),postMessage({type:"flvHeader",data:header})}for(;index<uint8.length;){var t=Object.create(null),n=index;if(!readable(11))return index=0,void(uint8=uint8.subarray(n));t.tagType=read(1)[0],t.dataSize=readBufferSum(read(3));var a=read(1)[0],o=read(1)[0],i=read(1)[0],u=read(1)[0];if(t.timestamp=i|o<<8|a<<16|u<<24,t.streamID=readBufferSum(read(3)),debug.error(0===t.streamID,"streamID should be equal to 0, but got ".concat(t.streamID)),!readable(t.dataSize+4))return index=0,void(uint8=uint8.subarray(n));t.body=read(t.dataSize);var c=readBufferSum(read(4));switch(debug.error(c===t.dataSize+11,"Invalid PrevTagSize: ".concat(c)),t.tagType){case 18:demuxerScripTag(t);break;case 9:demuxerVideoTag(t);break;case 8:demuxerAudioTag(t);break;default:debug.error(!1,"unknown tag type: ".concat(t.tagType))}}index=0,uint8=new Uint8Array};