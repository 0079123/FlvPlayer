/*!
 * FlvPlayer.js v1.0.7
 * Github: https://github.com/zhw2590582/FlvPlayer#readme
 * (c) 2017-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).FlvPlayer=t()}(this,function(){"use strict";var n=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var c=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var t=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e};function e(e,t){return e(t={exports:{}},t.exports),t.exports}var i=e(function(t){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e){return"function"==typeof Symbol&&"symbol"===r(Symbol.iterator)?t.exports=n=function(e){return r(e)}:t.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":r(e)},n(e)}t.exports=n});var r=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var a=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?r(e):t},u=e(function(t){function r(e){return t.exports=r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}t.exports=r}),s=e(function(r){function n(e,t){return r.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}r.exports=n});var d=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)},f=function(){function e(){c(this,e)}return t(e,[{key:"on",value:function(e,t,r){var n=this.e||(this.e={});return(n[e]||(n[e]=[])).push({fn:t,ctx:r}),this}},{key:"once",value:function(n,o,i){var a=this;function u(){a.off(n,u);for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];o.apply(i,t)}return u._=o,this.on(n,u,i)}},{key:"emit",value:function(e){for(var t=((this.e||(this.e={}))[e]||[]).slice(),r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];for(var i=0;i<t.length;i+=1)t[i].fn.apply(t[i].ctx,n);return this}},{key:"off",value:function(e,t){var r=this.e||(this.e={}),n=r[e],o=[];if(n&&t)for(var i=0,a=n.length;i<a;i+=1)n[i].fn!==t&&n[i].fn._!==t&&o.push(n[i]);return o.length?r[e]=o:delete r[e],this}}]),e}();function l(e){c(this,l);var i=e.options.debug;this.log=function(e){if(i){for(var t,r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=console).log.apply(t,["FlvPlayer: [".concat(e,"]")].concat(n))}},this.warn=function(e){if(!e&&i){for(var t,r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=console).warn.apply(t,n)}},this.error=function(e,t){if(!e)throw new y(t)}}var p=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")},h=e(function(n){function o(e,t,r){return!function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?n.exports=o=function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&s(o,r.prototype),o}:n.exports=o=Reflect.construct,o.apply(null,arguments)}n.exports=o}),y=function(e){function r(e){var t;return c(this,r),(t=a(this,u(r).call(this,e))).name="FlvPlayerError",t}return d(r,e),r}(e(function(t){function n(e){var r="function"==typeof Map?new Map:void 0;return t.exports=n=function(e){if(null===e||!p(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return h(e,arguments,u(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),s(t,e)},n(e)}t.exports=n})(Error)),m=function(){function e(){c(this,e),this.destroys=[],this.proxy=this.proxy.bind(this)}return t(e,[{key:"proxy",value:function(t,e,r,n){var o=this,i=3<arguments.length&&void 0!==n?n:{};if(Array.isArray(e))return e.map(function(e){return o.proxy(t,e,r,i)});t.addEventListener(e,r,i);function a(){return t.removeEventListener(e,r,i)}return this.destroys.push(a),a}},{key:"destroy",value:function(){this.destroys.forEach(function(e){return e()})}}]),e}();function g(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t[0].constructor;return t.reduce(function(e,t){var r=new n((0|e.byteLength)+(0|t.byteLength));return r.set(e,0),r.set(t,0|e.byteLength),r},new n)}function v(){return performance&&"function"==typeof performance.now?performance.now():Date.now()}function b(e,t,r){return Math.max(Math.min(e,Math.max(t,r)),Math.min(t,r))}function w(t,r,e){return"object"===i(r)&&Object.keys(r).forEach(function(e){w(t,e,r[e])}),t.style[r]=e,t}function S(r){for(var e=arguments.length,t=new Array(1<e?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];t.forEach(function(t){Object.getOwnPropertyNames(t).forEach(function(e){!function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(r,e)&&Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})})}function x(e){c(this,x),function(e,t){var r=e.options;r.container.classList.add("flvplayer-container"),w(r.container,{position:"relative",display:"flex",justifyContent:"center",alignItems:"center",boxSizing:"border-box"}),r.container.innerHTML='\n        <div class="flvplayer-inner" style="position: relative;display: flex;justify-content: center;align-items: center;width: 100%;height: 100%;">\n            <canvas class="flvplayer-canvas" width="'.concat(r.width,'" height="').concat(r.height,'" style="cursor: pointer;width: 100%;height: 100%;background-color: #000;"></canvas>\n        </div>\n    '),Object.defineProperty(t,"$container",{value:r.container}),Object.defineProperty(t,"$player",{value:r.container.querySelector(".flvplayer-inner")}),Object.defineProperty(t,"$canvas",{value:r.container.querySelector(".flvplayer-canvas")})}(e,this),function(r,a){Object.defineProperty(a,"rect",{get:function(){return a.$container.getBoundingClientRect()}}),["bottom","height","left","right","top","width"].forEach(function(e){Object.defineProperty(a,e,{get:function(){return a.rect[e]}})}),Object.defineProperty(a,"currentTime",{get:function(){return r.decoder.currentTime},set:function(e){r.options.live||r.decoder.seeked(b(e,0,a.loaded))}}),Object.defineProperty(a,"streaming",{get:function(){return r.demuxer.streaming}}),Object.defineProperty(a,"demuxed",{get:function(){return r.demuxer.demuxed}}),Object.defineProperty(a,"videoDecoding",{get:function(){return r.decoder.video.decoding}}),Object.defineProperty(a,"audioDecoding",{get:function(){return r.decoder.audio.decoding}}),Object.defineProperty(a,"duration",{get:function(){try{return r.demuxer.scripMeta.amf2.metaData.duration}catch(e){return r.options.duration||0}}}),Object.defineProperty(a,"frameRate",{get:function(){var t=Math.round(r.options.frameRate||30);try{return Math.round(r.demuxer.scripMeta.amf2.metaData.framerate)||t}catch(e){return t}}}),Object.defineProperty(a,"frameDuration",{get:function(){return 1e3/a.frameRate|0}}),Object.defineProperty(a,"isFocus",{value:!1,writable:!0}),Object.defineProperty(a,"volume",{get:function(){try{return r.decoder.audio.gainNode.gain.value}catch(e){return 0}},set:function(t){try{return r.decoder.audio.gainNode.gain.value=b(t,0,10),r.emit("volumechange",a.volume),a.volume}catch(e){return t}}}),Object.defineProperty(a,"loaded",{get:function(){return r.decoder.video.loaded}}),Object.defineProperty(a,"playing",{get:function(){return r.decoder.playing}}),Object.defineProperty(a,"play",{value:function(){a.playing||r.decoder.play()}}),Object.defineProperty(a,"pause",{value:function(){r.decoder.pause()}}),Object.defineProperty(a,"toggle",{value:function(){a.playing?a.pause():a.play()}}),Object.defineProperty(a,"autoSize",{value:function(){var e=a.width,t=a.height,r=e/t,n=a.$canvas.width/a.$canvas.height;if(n<r){var o=(e-t*n)/2;a.$container.style.padding="0 ".concat(o,"px")}else{var i=(t-e/n)/2;a.$container.style.padding="".concat(i,"px 0")}}})}(e,this),function(e,t){var r=e.events.proxy,n=document.createElement("object");n.setAttribute("aria-hidden","true"),n.setAttribute("tabindex",-1),n.type="text/html",n.data="about:blank",w(n,{display:"block",position:"absolute",top:"0",left:"0",height:"100%",width:"100%",overflow:"hidden",pointerEvents:"none",zIndex:"-1"});var o=t.width,i=t.height;r(n,"load",function(){r(n.contentDocument.defaultView,"resize",function(){t.width===o&&t.height===i||(o=t.width,i=t.height,e.emit("resize"))})}),t.$container.appendChild(n)}(e,this),function(e,o){var t=e.events.proxy;o.autoSize(),e.on("scripMeta",function(e){var t=e.amf2.metaData,r=t.width,n=t.height;o.$canvas.width=r,o.$canvas.height=n,o.autoSize()}),e.on("resize",function(){o.autoSize()}),t(window,["click","contextmenu"],function(e){-1<e.composedPath().indexOf(o.$container)?o.isFocus=!0:o.isFocus=!1}),t(o.$canvas,"click",function(){o.toggle()})}(e,this),S(e,this)}function O(n){var o=this;c(this,O);var t=n.options,i=n.debug;this.size=0,this.header=null,this.streaming=!1,this.demuxed=!1,this.videoDataSize=0,this.audioDataSize=0,this.videoDataLength=0,this.audioDataLength=0,this.streamStartTime=0,this.streamEndTime=0,this.scripMeta=null,this.AudioSpecificConfig=null,this.AVCDecoderConfigurationRecord=null,this.demuxWorker=function(e){return new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"})))}('"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}function _instanceof(e,r){return null!=r&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](e):e instanceof r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,r){if(!_instanceof(e,r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){return!r||"object"!==_typeof(r)&&"function"!=typeof r?_assertThisInitialized(e):r}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn\'t been initialised - super() hasn\'t been called");return e}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&_setPrototypeOf(e,r)}function _wrapNativeSuper(e){var r="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(t,e)})(e)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _construct(e,r,t){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(e,r,t){var n=[null];n.push.apply(n,r);var a=new(Function.bind.apply(e,n));return t&&_setPrototypeOf(a,t.prototype),a}).apply(null,arguments)}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _setPrototypeOf(e,r){return(_setPrototypeOf=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var FlvPlayerError=function(e){function r(e){var t;return _classCallCheck(this,r),(t=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,e))).name="FlvPlayerError",t}return _inherits(r,_wrapNativeSuper(Error)),r}(),debug={warn:function(e){if(!e){for(var r,t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];(r=console).warn.apply(r,n)}},error:function(e,r){if(!e)throw new FlvPlayerError(r)}};function mergeBuffer(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n=r[0].constructor;return r.reduce(function(e,r){var t=new n((0|e.byteLength)+(0|r.byteLength));return t.set(e,0),t.set(r,0|e.byteLength),t},new n)}function readBufferSum(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e.reduce(function(t,n,a){return t+(r?n:n-128)*256**(e.length-a-1)},0)}function readString(e){var r;return(r=String.fromCharCode).call.apply(r,[String].concat(_toConsumableArray(e)))}function readBuffer(e){var r=0;function t(n){for(var a=new Uint8Array(n),o=0;o<n;o+=1)a[o]=e[r],r+=1;return t.index=r,a}return t.index=0,t}function readDouble(e){var r=new DataView(new ArrayBuffer(e.length));return e.forEach(function(e,t){r.setUint8(t,e)}),r.getFloat64(0)}function readBoolean(e){return 0!==e[0]}var index=0,header=null,uint8=new Uint8Array,scripMeta=null,AudioSpecificConfig=null,AVCDecoderConfigurationRecord=null,nalStart=new Uint8Array([0,0,0,1]);function readable(e){return uint8.length-index>=e}function read(e){for(var r=new Uint8Array(e),t=0;t<e;t+=1)r[t]=uint8[index],index+=1;return r}function demuxerScripTag(e){var r=readBuffer(e.body),t=Object.create(null),n=Object.create(null);function a(e){var t=null;if(void 0!==e)switch(e){case 0:t=readDouble(r(8));break;case 1:t=readBoolean(r(1));break;case 2:var n=readBufferSum(r(2));t=readString(r(n));break;case 3:t=Object.create(null);for(var o=-1;9!==o;){var i=readBufferSum(r(2)),u=readString(r(i)),c=r(1)[0];u&&(t[u]=a(c)),o=c}break;case 5:t=null;break;case 6:t=void 0;break;case 7:t="Reference #".concat(r.index),r(2);break;case 8:t=Object.create(null);for(var f=-1;9!==f;){var d=readBufferSum(r(2)),s=readString(r(d)),l=r(1)[0];s&&(t[s]=a(l)),f=l}break;case 10:var g=readBufferSum(r(4));t=[];for(var p=0;p<g;p+=1){var y=r(1)[0];t.push(a(y))}break;case 11:t=readDouble(r(2));break;case 12:var b=readBufferSum(r(4));t=readString(r(b));break;default:debug.error(!1,"AMF: Unknown metaData type: ".concat(e))}return t}for(t.type=r(1)[0],debug.error(2===t.type,"AMF: [amf1] type expect 2, but got ".concat(t.type)),t.size=readBufferSum(r(2)),t.string=readString(r(t.size)),n.type=r(1)[0],debug.error(8===n.type||3===n.type,"AMF: [amf2] type expect 8 or 3, but got ".concat(n.type)),n.size=readBufferSum(r(4)),n.metaData=Object.create(null);r.index<e.body.length;){var o=readBufferSum(r(2)),i=readString(r(o)),u=r(1)[0];i&&(n.metaData[i]=a(u))}debug.error(r.index===e.body.length,"AMF: Seems to be incompletely parsed"),debug.error(n.size===Object.keys(n.metaData).length,"AMF: [amf2] length does not match"),postMessage({type:"scripMeta",data:scripMeta={amf1:t,amf2:n}})}function demuxerVideoTag(e){debug.error(e.body.length>1,"Invalid video packet");var r={frameType:(240&e.body[0])>>4,codecID:15&e.body[0]};debug.error(7===r.codecID,"[videoTrack] Unsupported codec in video frame: ".concat(r.codecID));var t=e.body.slice(1,5);debug.error(t.length>=4,"[H264] Invalid AVC packet, missing AVCPacketType or/and CompositionTime");var n=new DataView(t.buffer),a=n.getUint8(0),o=((16777215&n.getUint32(0))<<8>>8)+e.timestamp,i=e.body.subarray(5);if(0===a){debug.warn(!AVCDecoderConfigurationRecord,"[h264] Find another one AVCDecoderConfigurationRecord"),debug.error(i.length>=7,"[H264] AVCDecoderConfigurationRecord parse length is not enough");var u=readBuffer(i),c={};c.configurationVersion=u(1)[0],debug.error(1===c.configurationVersion,"[H264] Invalid configurationVersion: ".concat(c.configurationVersion)),c.AVCProfileIndication=u(1)[0],debug.error(0!==c.AVCProfileIndication,"[H264] Invalid AVCProfileIndication: ".concat(c.AVCProfileIndication)),c.profile_compatibility=u(1)[0],c.AVCLevelIndication=u(1)[0],c.lengthSizeMinusOne=1+(3&u(1)[0]),debug.error(4===c.lengthSizeMinusOne||3!==c.lengthSizeMinusOne,"[H264] Invalid lengthSizeMinusOne: ".concat(c.lengthSizeMinusOne)),c.numOfSequenceParameterSets=31&u(1)[0],debug.error(0!==c.numOfSequenceParameterSets,"[H264] Invalid numOfSequenceParameterSets: ".concat(c.numOfSequenceParameterSets)),debug.warn(1===c.numOfSequenceParameterSets,"[H264] Strange numOfSequenceParameterSets: ".concat(c.numOfSequenceParameterSets));for(var f=0;f<c.numOfSequenceParameterSets;f+=1)if(c.sequenceParameterSetLength=readBufferSum(u(2)),c.sequenceParameterSetLength>0){var d=u(c.sequenceParameterSetLength);postMessage({type:"videoData",data:mergeBuffer(nalStart,d)})}c.numOfPictureParameterSets=u(1)[0],debug.error(0!==c.numOfPictureParameterSets,"[H264] Invalid numOfPictureParameterSets: ".concat(c.numOfPictureParameterSets)),debug.warn(1===c.numOfPictureParameterSets,"[H264] Strange numOfPictureParameterSets: ".concat(c.numOfPictureParameterSets));for(var s=0;s<c.numOfPictureParameterSets;s+=1)if(c.pictureParameterSetLength=readBufferSum(u(2)),c.pictureParameterSetLength>0){var l=u(c.pictureParameterSetLength);postMessage({type:"videoData",data:mergeBuffer(nalStart,l)})}AVCDecoderConfigurationRecord=c,postMessage({type:"AVCDecoderConfigurationRecord",data:c})}else if(1===a)for(var g=AVCDecoderConfigurationRecord.lengthSizeMinusOne,p=readBuffer(i);p.index<i.length;){var y=readBufferSum(p(g));postMessage({type:"videoData",data:mergeBuffer(nalStart,p(y)),timestamp:o})}else debug.error(2===a,"[H264] Invalid video packet type ".concat(a))}function demuxerAudioTag(e){debug.error(e.body.length>1,"Invalid audio packet");var r={soundFormat:(240&e.body[0])>>4,soundRate:(12&e.body[0])>>2,soundSize:(2&e.body[0])>>1,soundType:(1&e.body[0])>>0};debug.error(10===r.soundFormat,"[audioTrack] unsupported audio format: ".concat(r.soundFormat));var t=e.body.subarray(1);if(0===t[0]){var n=t.subarray(1);debug.warn(!AudioSpecificConfig,"[aac] Find another one AudioSpecificConfig"),debug.error(n.length>=2,"[aac] AudioSpecificConfig parse length is not enough");var a={};a.audioObjectType=(248&n[0])>>3,a.samplingFrequencyIndex=((7&n[0])<<1)+((128&n[1])>>7&1),a.channelConfiguration=(127&n[1])>>3,AudioSpecificConfig=a,postMessage({type:"AudioSpecificConfig",data:a})}else{var o=AudioSpecificConfig,i=o.audioObjectType,u=o.samplingFrequencyIndex,c=o.channelConfiguration,f=e.dataSize-2+7,d=new Uint8Array(7);d[0]=255,d[1]=240,d[1]|=0,d[1]|=0,d[1]|=1,d[2]=i-1<<6,d[2]|=(15&u)<<2,d[2]|=0,d[2]|=(4&c)>>2,d[3]=(3&c)<<6,d[3]|=0,d[3]|=0,d[3]|=0,d[3]|=0,d[3]|=(6144&f)>>11,d[4]=(2040&f)>>3,d[5]=(7&f)<<5,d[5]|=31,d[6]=252;var s=e.body.subarray(2);postMessage({type:"audioData",data:mergeBuffer(d,s),timestamp:e.timestamp})}}onmessage=function(e){if(uint8=mergeBuffer(uint8,e.data),!header&&readable(13)){(header=Object.create(null)).signature=readString(read(3)),header.version=read(1)[0],debug.error("FLV"===header.signature&&1===header.version,"FLV header not found"),header.flags=read(1)[0],console.log(header.flags),debug.error(5===header.flags||1===header.flags,"FLV header flags not found video"),1===header.flags&&postMessage({type:"noAudio"}),header.headersize=readBufferSum(read(4));var r=readBufferSum(read(4));debug.error(0===r,"PrevTagSize0 should be equal to 0, but got ".concat(r)),postMessage({type:"flvHeader",data:header})}for(;index<uint8.length;){var t=Object.create(null),n=index;if(!readable(11))return index=0,void(uint8=uint8.subarray(n));t.tagType=read(1)[0],t.dataSize=readBufferSum(read(3));var a=read(1)[0],o=read(1)[0],i=read(1)[0],u=read(1)[0];if(t.timestamp=i|o<<8|a<<16|u<<24,t.streamID=readBufferSum(read(3)),debug.error(0===t.streamID,"streamID should be equal to 0, but got ".concat(t.streamID)),!readable(t.dataSize+4))return index=0,void(uint8=uint8.subarray(n));t.body=read(t.dataSize);var c=readBufferSum(read(4));switch(debug.error(c===t.dataSize+11,"Invalid PrevTagSize: ".concat(c)),t.tagType){case 18:demuxerScripTag(t);break;case 9:demuxerVideoTag(t);break;case 8:demuxerAudioTag(t);break;default:debug.error(!1,"unknown tag type: ".concat(t.tagType))}}index=0,uint8=new Uint8Array};'),n.on("destroy",function(){o.demuxWorker.terminate()}),n.on("streamStart",function(e){o.streamStartTime=v(),i.log("stream-url",t.url),i.log("stream-request",e)}),n.on("streaming",function(e){o.streaming=!0,o.size+=e.byteLength,o.demuxWorker.postMessage(e)}),n.on("streamEnd",function(e){o.streaming=!1,o.streamEndTime=v(),e&&(o.index=0,o.size=e.byteLength,o.demuxWorker.postMessage(e)),i.log("stream-size","".concat(o.size," byte")),i.log("stream-time","".concat(o.streamEndTime-o.streamStartTime," ms")),o.demuxed=!0,n.emit("demuxDone"),i.log("demux-done")});var a=new Uint8Array,u=new Uint8Array;this.demuxWorker.onmessage=function(e){var t=e.data;switch(t.type){case"flvHeader":o.header=t.data,n.emit("flvHeader",o.header),i.log("flv-header",o.header);break;case"noAudio":n.emit("noAudio"),i.log("flv-flags","FLV header flags not found audio");break;case"scripMeta":o.scripMeta=t.data,n.emit("scripMeta",o.scripMeta),i.log("scrip-meta",o.scripMeta);break;case"AVCDecoderConfigurationRecord":o.AVCDecoderConfigurationRecord=t.data,n.emit("AVCDecoderConfigurationRecord",o.AVCDecoderConfigurationRecord),i.log("AVCDecoderConfigurationRecord",o.AVCDecoderConfigurationRecord);break;case"AudioSpecificConfig":o.AudioSpecificConfig=t.data,n.emit("AudioSpecificConfig",o.AudioSpecificConfig),i.log("AudioSpecificConfig",o.AudioSpecificConfig);break;case"videoData":o.videoDataLength+=1,o.videoDataSize+=t.data.byteLength;var r=function(n){var o=0;function i(e){for(var t=new Uint8Array(e),r=0;r<e;r+=1)t[r]=n[o],o+=1;return i.index=o,t}return i.index=0,i}(t.data);switch(r(4),31&r(1)[0]){case 1:case 5:n.emit("videoData",g(a,u,t.data),t.timestamp);break;case 7:a=t.data;break;case 8:u=t.data}break;case"audioData":o.audioDataLength+=1,o.audioDataSize+=t.data.byteLength,n.emit("audioData",t.data,t.timestamp)}}}var P=function(){function e(n){var o=this;c(this,e),this.flv=n,this.context=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.context.createGain(),this.gainNode.gain.value=n.options.volume,this.playing=!1,this.playIndex=0,this.audiobuffers=[],this.timestamps=[],this.audioInputLength=0,this.decoding=!1,this.byteSize=0,this.loaded=0,n.on("destroy",function(){o.audiobuffers=[],o.stop()});var i=[];this.decodeErrorBuffer=new Uint8Array,this.decodeWaitingBuffer=new Uint8Array,n.on("audioData",function(e,t){if(o.decoding=!0,o.audioInputLength+=1,131072<=o.decodeWaitingBuffer.byteLength){o.timestamps.push(i[0]),i=[];var r=g(o.decodeErrorBuffer,o.decodeWaitingBuffer).buffer;o.decodeWaitingBuffer=new Uint8Array,o.context.decodeAudioData(r,function(e){o.loaded+=e.duration,o.byteSize+=e.length,o.audiobuffers.push(e),n.emit("audioLoaded",o.loaded),o.decodeErrorBuffer=new Uint8Array}).catch(function(){o.decodeErrorBuffer=g(o.decodeErrorBuffer,o.decodeWaitingBuffer)})}else i.push(t),o.decodeWaitingBuffer=g(o.decodeWaitingBuffer,e)}),n.on("timeupdate",function(e){o.flv.demuxer.demuxed&&o.decodeWaitingBuffer.length&&(o.timestamps.push(i[0]),i=[],o.context.decodeAudioData(o.decodeWaitingBuffer.buffer,function(e){o.decodeWaitingBuffer=new Uint8Array,o.decodeErrorBuffer=new Uint8Array,o.loaded+=e.duration,o.byteSize+=e.length,o.audiobuffers.push(e),n.emit("audioLoaded",o.loaded),o.decoding=!1}));var t=o.timestamps[o.playIndex];t&&t<=1e3*e&&(o.queue(o.playIndex)?o.playIndex+=1:o.stop())})}return t(e,[{key:"queue",value:function(e){var t=this,r=this.audiobuffers[e];return!!r&&(this.source=this.context.createBufferSource(),this.source.buffer=r,this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.source.onended=function(){t.flv.options.live&&(t.audiobuffers[e]=null)},this.playing=!0,this.source.start(),!0)}},{key:"play",value:function(e){var t=this,r=0<arguments.length&&void 0!==e?e:0;this.stop();var n=0,o=this.audiobuffers.findIndex(function(e){return n+=e.duration,r<=n}),i=this.audiobuffers[o];if(i){var a=r-(n-i.duration);this.source=this.context.createBufferSource(),this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.source.buffer=i,this.source.onended=function(){t.flv.options.live&&(t.audiobuffers[o]=null)},this.playing=!0,this.source.start(0,a),this.playIndex=o+1}else this.stop()}},{key:"stop",value:function(){this.playing=!1,this.source&&(this.source.onended=null,this.source.stop())}}]),e}(),A=function(){function n(t){var r=this;c(this,n),this.flv=t,this.ended=!1,this.playing=!1,this.waiting=!1,this.animationFrameTimer=null,this.waitingTimer=null,this.endedTimer=null,this.currentTime=0,this.lastUpdateTime=0,this.video=new window.FlvplayerDecoder(t,this),t.options.hasAudio?this.audio=new P(t,this):this.audio={play:function(){return null},stop:function(){return null},playing:!0,decoding:!1},t.on("noAudio",function(){t.options.hasAudio=!1,r.audio={play:function(){return null},stop:function(){return null},playing:!0,decoding:!1}}),t.on("ready",function(){t.options.autoPlay?r.play():r.video.draw(0)}),t.on("destroy",function(){r.pause()}),t.on("timeupdate",function(e){!t.options.live&&e>=t.player.duration&&r.pause()});var e=!1;t.events.proxy(document,"visibilitychange",function(){document.hidden&&(e=r.playing,r.pause()),!document.hidden&&e&&(e=r.playing,r.play())})}return t(n,[{key:"play",value:function(){this.lastUpdateTime=v(),this.video.play(this.currentTime),this.audio.play(this.currentTime),this.animationFrame(),this.flv.emit("play")}},{key:"animationFrame",value:function(){var t=this,e=this.flv,r=e.options,n=e.player;this.animationFrameTimer=window.requestAnimationFrame(function(){if(t.video.playing&&t.audio.playing){t.ended=!1,t.playing=!0,t.waiting=!1;var e=v();t.currentTime+=(e-t.lastUpdateTime)/1e3,t.lastUpdateTime=e,t.flv.emit("timeupdate",t.currentTime)}else{if(n.streaming||t.video.decoding||t.audio.decoding)return t.ended=!1,t.playing=!1,t.waiting=!0,t.flv.emit("waiting",t.currentTime),void(t.waitingTimer=setTimeout(function(){t.play()},1e3));if(t.ended=!0,t.playing=!1,t.waiting=!1,t.flv.emit("ended",t.currentTime),r.loop&&!r.live)return t.currentTime=0,void(t.endedTimer=setTimeout(function(){t.play(),t.flv.emit("loop")},1e3));t.pause()}t.animationFrame()})}},{key:"pause",value:function(){window.cancelAnimationFrame(this.animationFrameTimer),window.clearTimeout(this.waitingTimer),window.clearTimeout(this.endedTimer),this.animationFrameTimer=null,this.waitingTimer=null,this.endedTimer=null,this.video.stop(),this.audio.stop(),this.ended=!1,this.playing=!1,this.waiting=!1,this.flv.emit("pause")}},{key:"seeked",value:function(e){var t=this.flv.player;window.cancelAnimationFrame(this.animationFrameTimer),window.clearTimeout(this.waitingTimer),window.clearTimeout(this.endedTimer),this.animationFrameTimer=null,this.waitingTimer=null,this.endedTimer=null,this.currentTime=e,this.video.draw(Math.floor(e*t.frameRate)),this.playing&&this.play(),this.flv.emit("seeked",e)}}]),n}();function T(o,e){return o.emit("streamStart","fetch-request"),fetch(e,{headers:o.options.headers}).then(function(e){var t=e.body.getReader();return o.on("destroy",function(){t.cancel()}),function n(){t.read().then(function(e){var t=e.done,r=e.value;t?o.emit("streamEnd"):(o.emit("streaming",new Uint8Array(r)),n())}).catch(function(e){throw e})}(),t})}function k(e,t){e.emit("streamStart","moz-xhr-request");var r=e.events.proxy,n=e.options.headers,o=new XMLHttpRequest;return o.open("GET",t,!0),o.responseType="moz-chunked-arraybuffer",Object.keys(n).forEach(function(e){o.setRequestHeader(e,n[e])}),r(o,"readystatechange",function(){e.emit("readystatechange",o)}),r(o,"progress",function(){e.emit("streaming",new Uint8Array(o.response))}),r(o,"loadend",function(){e.emit("streamEnd")}),r(o,"error",function(e){throw e}),e.on("destroy",function(){o.abort()}),o.send(),o}function j(t,e){t.emit("streamStart","xhr-request");var r=t.events.proxy,n=t.options.headers,o=new TextEncoder,i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="text",Object.keys(n).forEach(function(e){i.setRequestHeader(e,n[e])});var a=0;return r(i,"readystatechange",function(){t.emit("readystatechange",i)}),r(i,"progress",function(){var e=i.responseText.substr(a);a=i.responseText.length,t.emit("streaming",o.encode(e,{stream:!0}))}),r(i,"loadend",function(){t.emit("streaming",o.encode("",{stream:!1})),t.emit("streamEnd")}),r(i,"error",function(e){throw e}),t.on("destroy",function(){i.abort()}),i.send(),i}function C(t,e){t.emit("streamStart","websocket-request");var r=t.options,n=t.events.proxy,o=new WebSocket(e);return o.binaryType="arraybuffer",n(o,"open",function(){o.send(r.socketSend)}),n(o,"message",function(e){t.emit("streaming",new Uint8Array(e.data))}),n(o,"close",function(){t.emit("streamEnd")}),n(o,"error",function(e){throw e}),t.on("destroy",function(){o.close()}),o}function D(r,e){r.emit("streamStart","FileReader");var t=r.events.proxy,n=new FileReader;return t(n,"load",function(e){var t=e.target.result;r.emit("streamEnd",new Uint8Array(t))}),n.readAsArrayBuffer(e),n}var _=function(){function r(e){c(this,r);var t=e.options.url;this.transportFactory=r.getStreamFactory(t),this.transport=this.transportFactory(e,t)}return t(r,null,[{key:"supportsXhrResponseType",value:function(e){try{var t=new XMLHttpRequest;return t.responseType=e,t.responseType===e}catch(e){return!1}}},{key:"getStreamFactory",value:function(e){if(e instanceof File)return D;if(e.startsWith("ws://"))return C;if("undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers)return T;return r.supportsXhrResponseType("moz-chunked-arraybuffer")?k:j}}]),r}();function F(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}var B=0,M=function(){function r(e){var t;return c(this,r),(t=a(this,u(r).call(this))).options=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?F(r,!0).forEach(function(e){n(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):F(r).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({},r.options,{},e),"string"==typeof t.options.container&&(t.options.container=document.querySelector(t.options.container)),window.FlvplayerDecoder?t.init():function(n,o){return new Promise(function(e,t){var r=document.createElement("script");r.type="text/javascript",r.onload=function(){window[o]?e(window[o]):t(new Error("Unable to find global variable '".concat(o,"' from '").concat(n,"'")))},r.onerror=function(){t(new Error("Resource loading failed '".concat(n,"'")))},r.src=n,document.head.appendChild(r)})}(t.options.decoder,"FlvplayerDecoder").then(function(){t.init()}),t}return d(r,f),t(r,[{key:"init",value:function(){this.isDestroy=!1,this.userAgent=window.navigator.userAgent,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(this.userAgent),this.debug=new l(this),this.events=new m(this),this.player=new x(this),this.decoder=new A(this),this.demuxer=new O(this),this.stream=new _(this),window.FlvplayerControl&&(this.control=new window.FlvplayerControl(this)),B+=1,this.id=B,r.instances.push(this)}},{key:"destroy",value:function(){this.events.destroy(),this.isDestroy=!0,this.options.container.innerHTML="",r.instances.splice(r.instances.indexOf(this),1),this.emit("destroy")}}],[{key:"options",get:function(){return{url:"",container:"",debug:!1,live:!1,loop:!1,autoPlay:!1,hasAudio:!0,volume:7,frameRate:30,width:400,height:300,socketSend:"",headers:{},decoder:"./flvplayer-decoder-baseline.js"}}},{key:"version",get:function(){return"1.0.7"}},{key:"env",get:function(){return'"production"'}}]),r}();return Object.defineProperty(M,"instances",{value:[]}),M});
