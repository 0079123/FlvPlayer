/*!
 * FlvPlayer.js v1.0.9
 * Github: https://github.com/zhw2590582/FlvPlayer#readme
 * (c) 2017-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).FlvPlayer=n()}(this,function(){"use strict";var r=function(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e};var c=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")};function i(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var n=function(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),e};function e(e,n){return e(n={exports:{}},n.exports),n.exports}var a=e(function(n){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e){return"function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?n.exports=r=function(e){return t(e)}:n.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)},r(e)}n.exports=r});var t=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var o=function(e,n){return!n||"object"!==a(n)&&"function"!=typeof n?t(e):n},u=e(function(n){function t(e){return n.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(e)}n.exports=t}),s=e(function(t){function r(e,n){return t.exports=r=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e},r(e,n)}t.exports=r});var d=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&s(e,n)},f=function(){function o(){c(this,o)}return n(o,[{key:"on",value:function(e,n,t){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:n,ctx:t}),this}},{key:"once",value:function(r,i,a){var o=this;function u(){o.off(r,u);for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];i.apply(a,n)}return u._=i,this.on(r,u,a)}},{key:"emit",value:function(e){this.options.debug&&(o[this.id]||(o[this.id]={}),o[this.id][e]?o[this.id][e]+=1:o[this.id][e]=1);for(var n=((this.e||(this.e={}))[e]||[]).slice(),t=arguments.length,r=new Array(1<t?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];for(var a=0;a<n.length;a+=1)n[a].fn.apply(n[a].ctx,r);return this}},{key:"off",value:function(e,n){var t=this.e||(this.e={}),r=t[e],i=[];if(r&&n)for(var a=0,o=r.length;a<o;a+=1)r[a].fn!==n&&r[a].fn._!==n&&i.push(r[a]);return i.length?t[e]=i:delete t[e],this}}]),o}();function l(e){c(this,l);var a=e.options.debug;this.log=function(e){if(a){for(var n,t=arguments.length,r=new Array(1<t?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];(n=console).log.apply(n,["FlvPlayer: [".concat(e,"]")].concat(r))}},this.warn=function(e){if(!e&&a){for(var n,t=arguments.length,r=new Array(1<t?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];(n=console).warn.apply(n,r)}},this.error=function(e,n){if(!e)throw new m(n)}}var p=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")},h=e(function(r){function i(e,n,t){return!function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?r.exports=i=function(e,n,t){var r=[null];r.push.apply(r,n);var i=new(Function.bind.apply(e,r));return t&&s(i,t.prototype),i}:r.exports=i=Reflect.construct,i.apply(null,arguments)}r.exports=i}),m=function(e){function t(e){var n;return c(this,t),(n=o(this,u(t).call(this,e))).name="FlvPlayerError",n}return d(t,e),t}(e(function(n){function r(e){var t="function"==typeof Map?new Map:void 0;return n.exports=r=function(e){if(null===e||!p(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return h(e,arguments,u(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,e)},r(e)}n.exports=r})(Error)),g=function(){function t(e){var n=this;c(this,t),this.destroys=[],this.proxy=this.proxy.bind(this),e.on("destroy",function(){n.destroy()})}return n(t,[{key:"proxy",value:function(n,e,t,r){var i=this,a=3<arguments.length&&void 0!==r?r:{};if(Array.isArray(e))return e.map(function(e){return i.proxy(n,e,t,a)});n.addEventListener(e,t,a);function o(){return n.removeEventListener(e,t,a)}return this.destroys.push(o),o}},{key:"destroy",value:function(){this.destroys.forEach(function(e){return e()})}}]),t}();function y(e,n){return Object.prototype.hasOwnProperty.call(e,n)}function v(r){var i=0;function a(e){for(var n=new Uint8Array(e),t=0;t<e;t+=1)n[t]=r[i],i+=1;return a.index=i,n}return a.index=0,a}function b(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];var r=n[0].constructor;return n.reduce(function(e,n){var t=new r((0|e.byteLength)+(0|n.byteLength));return t.set(e,0),t.set(n,0|e.byteLength),t},new r)}function S(e){return new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"})))}function T(){return performance&&"function"==typeof performance.now?performance.now():Date.now()}function w(e,n,t){return Math.max(Math.min(e,Math.max(n,t)),Math.min(n,t))}function x(r,i){return new Promise(function(e,n){var t=document.createElement("script");t.type="text/javascript",t.onload=function(){window[i]?e(window[i]):n(new Error("Unable to find global variable '".concat(i,"' from '").concat(r,"'")))},t.onerror=function(){n(new Error("Resource loading failed '".concat(r,"'")))},t.src=r,document.head.appendChild(t)})}function D(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];n.forEach(function(n){Object.getOwnPropertyNames(n).forEach(function(e){if(y(t,e))throw new Error("Target attribute name is duplicated: ".concat(e));Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})})}function A(r){var i=0,a=T();return function(e){i+=e;var n=T(),t=n-a;1e3<=t&&(r(i/t*1e3),a=n,i=0)}}var k=Object.freeze({hasOwnProperty:y,readBuffer:v,mergeBuffer:b,createWorker:S,secondToTime:function(e){var n=Math.floor(e/3600),t=Math.floor((e-3600*n)/60),r=Math.floor(e-3600*n-60*t);return(0<n?[n,t,r]:[t,r]).map(function(e){return e<10?"0".concat(e):String(e)}).join(":")},getNowTime:T,debounce:function(r,i,a){var o;function e(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];clearTimeout(o),o=setTimeout(function(){o=null,r.apply(a,n)},i)}return e.clearTimeout=function(){clearTimeout(o)},e},throttle:function(i,a){var o,u,c=!1;return function e(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];if(c)return o=t,void(u=this);c=!0,i.apply(this,t),setTimeout(function(){c=!1,o&&(e.apply(u,o),u=o=null)},a)}},clamp:w,setStyle:function n(t,r,e){return"object"===a(r)&&Object.keys(r).forEach(function(e){n(t,e,r[e])}),t.style[r]=e,t},getStyle:function(e,n){var t=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=getComputedStyle(e,null).getPropertyValue(n);return t?parseFloat(r):r},loadScript:x,proxyPropertys:D,calculationRate:A});function O(e){c(this,O),function(e,n){var t=e.options,r=t.container.style.cssText;t.container.classList.add("flvplayer-container"),t.container.innerHTML='\n        <div class="flvplayer-player">\n            <canvas class="flvplayer-canvas" width="'.concat(t.width,'" height="').concat(t.height,'"></canvas>\n        </div>\n    '),e.on("destroy",function(){t.container.innerHTML="",t.container.style.cssText=r,t.container.classList.remove("flvplayer-container")}),Object.defineProperty(n,"$container",{value:t.container}),Object.defineProperty(n,"$player",{value:t.container.querySelector(".flvplayer-player")}),Object.defineProperty(n,"$canvas",{value:t.container.querySelector(".flvplayer-canvas")})}(e,this),function(t,r){Object.defineProperty(r,"rect",{get:function(){return r.$container.getBoundingClientRect()}}),["bottom","height","left","right","top","width"].forEach(function(e){Object.defineProperty(r,e,{get:function(){return r.rect[e]}})}),Object.defineProperty(r,"currentTime",{get:function(){return t.decoder.currentTime},set:function(e){t.options.cache&&t.decoder.seeked(w(e,0,r.loaded))}}),Object.defineProperty(r,"streaming",{get:function(){return t.demuxer.streaming}}),Object.defineProperty(r,"demuxed",{get:function(){return t.demuxer.demuxed}}),Object.defineProperty(r,"videoDecoding",{get:function(){return t.decoder.video.decoding}}),Object.defineProperty(r,"audioDecoding",{get:function(){return t.decoder.audio.decoding}}),Object.defineProperty(r,"duration",{get:function(){try{return t.demuxer.scripMeta.amf2.metaData.duration}catch(e){return t.options.duration||0}}}),Object.defineProperty(r,"frameRate",{get:function(){var n=Math.round(t.options.frameRate||30);try{return Math.round(t.demuxer.scripMeta.amf2.metaData.framerate)||n}catch(e){return n}}}),Object.defineProperty(r,"frameDuration",{get:function(){return 1e3/r.frameRate|0}}),Object.defineProperty(r,"muted",{get:function(){return t.decoder.audio.muted},set:function(e){t.decoder.audio.muted=e}}),Object.defineProperty(r,"volume",{get:function(){try{return t.decoder.audio.volume}catch(e){return 0}},set:function(n){try{return t.decoder.audio.volume=w(n,0,10),r.volume}catch(e){return n}}}),Object.defineProperty(r,"loaded",{get:function(){return t.decoder.video.loaded}}),Object.defineProperty(r,"playing",{get:function(){return t.decoder.playing}}),Object.defineProperty(r,"play",{value:function(){r.playing||t.decoder.play()}}),Object.defineProperty(r,"pause",{value:function(){t.decoder.pause()}}),Object.defineProperty(r,"toggle",{value:function(){r.playing?r.pause():r.play()}})}(e,this),function(e,i){var n=e.events.proxy;e.on("scripMeta",function(e){var n=e.amf2.metaData,t=n.width,r=n.height;t&&r&&(i.$canvas.width=t,i.$canvas.height=r)}),n(i.$canvas,"click",function(){i.toggle()})}(e,this),D(e,this)}function P(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,r)}return t}function C(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];var r=n[0].constructor;return n.reduce(function(e,n){var t=new r((0|e.byteLength)+(0|n.byteLength));return t.set(e,0),t.set(n,0|e.byteLength),t},new r)}var j=function(){function t(){var e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};c(this,t),this.option=function(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?P(t,!0).forEach(function(e){r(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):P(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}({},t.option,{},n),this.context=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.context.createGain(),this.gainNode.gain.value=this.option.volume,this.source=null,this.decoding=!1,this.playing=!1,this.loadLength=0,this.loadByteSize=0,this.audioDuration=0,this.audioLength=0,this.timestamps=[],this.audiobuffers=[],this.timestampTmp=[],this.decodeErrorBuffer=new Uint8Array,this.decodeWaitingBuffer=new Uint8Array,this.autoEndDebounce=function(r,i,a){var o;return function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];clearTimeout(o),o=setTimeout(function(){o=null,r.apply(a,n)},i)}}(function(){e.end()},this.option.autoEndTime)}return n(t,[{key:"destroy",value:function(){return this.stop(),this.context=null,this.gainNode=null,this.source=null,this.timestamps=[],this.audiobuffers=[],this.timestampTmp=[],this.decodeErrorBuffer=new Uint8Array,this.decodeWaitingBuffer=new Uint8Array,this.option.onDestroy(),this}},{key:"load",value:function(e,n){var t=this;if(this.decoding=!0,this.loadLength+=1,this.loadByteSize+=e.byteLength,this.option.onLoad(e,n),this.decodeWaitingBuffer.byteLength>=this.option.chunk){this.timestamps.push(this.timestampTmp[0]),this.timestampTmp=[];var r=C(this.decodeErrorBuffer,this.decodeWaitingBuffer).buffer;this.decodeWaitingBuffer=new Uint8Array,this.context.decodeAudioData(r,function(e){t.audioDuration+=e.duration,t.audioLength+=e.length,t.audiobuffers.push(e),t.decodeErrorBuffer=new Uint8Array,t.option.onDecodeDone(e)},function(e){t.decodeErrorBuffer=C(t.decodeErrorBuffer,t.decodeWaitingBuffer),t.option.onDecodeError(e)})}else this.timestampTmp.push(n),this.decodeWaitingBuffer=C(this.decodeWaitingBuffer,e);return this.option.autoEnd&&this.autoEndDebounce(),this}},{key:"end",value:function(){var n=this;if(this.decodeWaitingBuffer.length){this.timestamps.push(this.timestampTmp[0]),this.timestampTmp=[];var e=this.decodeWaitingBuffer.buffer;this.decodeWaitingBuffer=new Uint8Array,this.decodeErrorBuffer=new Uint8Array,this.context.decodeAudioData(e,function(e){n.audioDuration+=e.duration,n.audioLength+=e.length,n.audiobuffers.push(e),n.decoding=!1,n.option.onEnd()})}return this}},{key:"play",value:function(e){var r=this,i=0<arguments.length&&void 0!==e?e:0;this.source&&(this.source.onended=null,this.source.stop(),this.source=null),this.playing=!0;var t=this.timestamps.findIndex(function(e,n){var t=r.audiobuffers[n];return t&&e+1e3*t.duration>=i}),a=this.timestamps[t],n=this.audiobuffers[t];if(void 0===a||void 0===n)return this.stop(t,a);var o=Math.max(0,(i-a)/1e3);return this.source=this.context.createBufferSource(),this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.source.buffer=n,this.option.onPlay(n,i,o),this.source.start(0,o),this.source.onended=function(){var e=r.timestamps[t+1],n=r.audiobuffers[t+1];void 0!==e&&void 0!==n?(r.play(r.option.onNext(e)),r.option.cache||(r.audiobuffers.splice(0,t+1),r.timestamps.splice(0,t+1))):r.stop(t,a)},this}},{key:"stop",value:function(e,n){return this.playing=!1,this.source&&(this.source.onended=null,this.source.stop(),this.source=null),this.option.onStop(e,n),this}},{key:"volume",get:function(){return this.gainNode.gain.value},set:function(e){this.volume!==e&&(this.gainNode.gain.value=e,this.option.onVolumeChange(e))}}],[{key:"option",get:function(){return{volume:.7,cache:!0,chunk:65536,autoEnd:!0,autoEndTime:5e3,onNext:function(e){return e},onLoad:function(){return null},onStop:function(){return null},onPlay:function(){return null},onEnd:function(){return null},onDestroy:function(){return null},onDecodeDone:function(){return null},onDecodeError:function(){return null},onVolumeChange:function(){return null}}}}]),t}(),L=function(){function e(t,r){var i=this;c(this,e),this.flv=t,this.dida=new j({volume:t.options.muted?0:t.options.volume,cache:t.options.cache,onNext:function(e){var n=1e3*r.currentTime;return Math.abs(e-n)>=t.options.maxTimeDiff?n:e}}),t.on("audioData",function(e,n){i.dida.load(e,n)}),t.on("destroy",function(){i.dida.destroy()})}return n(e,[{key:"play",value:function(e){var n=0<arguments.length&&void 0!==e?e:0;this.dida.play(1e3*n)}},{key:"stop",value:function(){this.dida.stop()}},{key:"muted",get:function(){return 0===this.volume},set:function(e){this.volume=e?0:7}},{key:"volume",get:function(){return this.dida.volume},set:function(e){this.dida.volume=e,this.flv.emit("volumechange",e)}},{key:"decoding",get:function(){return this.dida.decoding}},{key:"playing",get:function(){return this.dida.playing}}]),e}(),B=function(){function r(n){var t=this;c(this,r),this.flv=n,this.ended=!1,this.playing=!1,this.waiting=!1,this.animationFrameTimer=null,this.waitingTimer=null,this.currentTime=0,this.lastUpdateTime=0,this.video=new window.FlvplayerDecoder(n,this),n.options.hasAudio?this.audio=new L(n,this):this.audio={play:function(){return null},stop:function(){return null},playing:!0,decoding:!1},n.on("ready",function(){n.options.autoPlay?t.play():t.video.draw(0)}),n.on("destroy",function(){t.pause()}),n.on("timeupdate",function(e){!n.options.live&&e>=n.player.duration&&t.pause()});var e=!1;n.events.proxy(document,"visibilitychange",function(){document.hidden?(e=t.playing,t.pause()):e&&t.play()})}return n(r,[{key:"play",value:function(){this.lastUpdateTime=T(),this.video.play(this.currentTime),this.audio.play(this.currentTime),this.animationFrame(),this.flv.emit("play")}},{key:"animationFrame",value:function(){var n=this,e=this.flv,t=e.options,r=e.player;this.animationFrameTimer=requestAnimationFrame(function(){if(!n.video.playing||!n.audio.playing)return r.streaming||n.video.decoding||n.audio.decoding?(n.ended=!1,n.playing=!0,n.waiting=!0,n.flv.emit("waiting",n.currentTime),void(n.waitingTimer=setTimeout(function(){n.play()},1e3))):(n.ended=!0,n.playing=!1,n.waiting=!1,n.flv.emit("ended",n.currentTime),void(t.loop&&t.cache?(n.currentTime=0,n.play(),n.flv.emit("loop")):n.pause()));n.ended=!1,n.playing=!0,n.waiting=!1;var e=T();n.currentTime+=(e-n.lastUpdateTime)/1e3,n.lastUpdateTime=e,n.flv.emit("timeupdate",n.currentTime),n.animationFrame()})}},{key:"pause",value:function(){cancelAnimationFrame(this.animationFrameTimer),clearTimeout(this.waitingTimer),this.animationFrameTimer=null,this.waitingTimer=null,this.video.stop(),this.audio.stop(),this.ended=!1,this.playing=!1,this.waiting=!1,this.flv.emit("pause")}},{key:"seeked",value:function(e){var n=this.flv.player;cancelAnimationFrame(this.animationFrameTimer),clearTimeout(this.waitingTimer),this.animationFrameTimer=null,this.waitingTimer=null,this.currentTime=e,this.video.draw(Math.floor(e*n.frameRate)),this.playing&&this.play(),this.flv.emit("seeked",e)}}]),r}();function E(r){var i=this;c(this,E);var n=r.options,a=r.debug;this.size=0,this.header=null,this.streaming=!1,this.demuxed=!1,this.videoDataSize=0,this.audioDataSize=0,this.videoDataLength=0,this.audioDataLength=0,this.streamStartTime=0,this.streamEndTime=0,this.scripMeta=null,this.AudioSpecificConfig=null,this.AVCDecoderConfigurationRecord=null,this.demuxWorker=S("class FlvPlayerError extends Error {\n    constructor(message) {\n        super(message);\n        this.name = 'FlvPlayerError';\n    }\n}\n\nconst debug = {\n    warn: (condition, ...args) => {\n        if (!condition) {\n            console.warn(...args);\n        }\n    },\n    error: (condition, msg) => {\n        if (!condition) {\n            throw new FlvPlayerError(msg);\n        }\n    },\n};\n\nfunction mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nfunction readBufferSum(array, uint = true) {\n    return array.reduce((totle, num, index) => totle + (uint ? num : num - 128) * 256 ** (array.length - index - 1), 0);\n}\n\nfunction readString(array) {\n    return String.fromCharCode.call(String, ...array);\n}\n\nfunction readBuffer(buffer) {\n    let index = 0;\n    function read(length) {\n        const tempUint8 = new Uint8Array(length);\n        for (let i = 0; i < length; i += 1) {\n            tempUint8[i] = buffer[index];\n            index += 1;\n        }\n        read.index = index;\n        return tempUint8;\n    }\n    read.index = 0;\n    return read;\n}\n\nfunction readDouble(array) {\n    const view = new DataView(new ArrayBuffer(array.length));\n    array.forEach((b, i) => {\n        view.setUint8(i, b);\n    });\n    return view.getFloat64(0);\n}\n\nfunction readBoolean(array) {\n    return array[0] !== 0;\n}\n\nlet index = 0;\nlet header = null;\nlet uint8 = new Uint8Array();\nlet scripMeta = null;\nlet AudioSpecificConfig = null;\nlet AVCDecoderConfigurationRecord = null;\nconst nalStart = new Uint8Array([0x00, 0x00, 0x00, 0x01]);\n\nfunction readable(length) {\n    return uint8.length - index >= length;\n}\n\nfunction read(length) {\n    const tempUint8 = new Uint8Array(length);\n    for (let i = 0; i < length; i += 1) {\n        tempUint8[i] = uint8[index];\n        index += 1;\n    }\n    return tempUint8;\n}\n\nfunction demuxerScripTag(tag) {\n    const readScripTag = readBuffer(tag.body);\n    const amf1 = Object.create(null);\n    const amf2 = Object.create(null);\n\n    amf1.type = readScripTag(1)[0];\n    debug.error(amf1.type === 2, `AMF: [amf1] type expect 2, but got ${amf1.type}`);\n    amf1.size = readBufferSum(readScripTag(2));\n    amf1.string = readString(readScripTag(amf1.size));\n\n    amf2.type = readScripTag(1)[0];\n    debug.error(amf2.type === 8 || amf2.type === 3, `AMF: [amf2] type expect 8 or 3, but got ${amf2.type}`);\n    amf2.size = readBufferSum(readScripTag(4));\n    amf2.metaData = Object.create(null);\n\n    function getValue(type) {\n        let value = null;\n        if (type !== undefined) {\n            switch (type) {\n                case 0:\n                    value = readDouble(readScripTag(8));\n                    break;\n                case 1:\n                    value = readBoolean(readScripTag(1));\n                    break;\n                case 2: {\n                    const valueLength = readBufferSum(readScripTag(2));\n                    value = readString(readScripTag(valueLength));\n                    break;\n                }\n                case 3: {\n                    value = Object.create(null);\n                    let lastType = -1;\n                    while (lastType !== 9) {\n                        const nameLength = readBufferSum(readScripTag(2));\n                        const name = readString(readScripTag(nameLength));\n                        const itemType = readScripTag(1)[0];\n                        if (name) {\n                            value[name] = getValue(itemType);\n                        }\n                        lastType = itemType;\n                    }\n                    break;\n                }\n                case 5:\n                    value = null;\n                    break;\n                case 6:\n                    value = undefined;\n                    break;\n                case 7:\n                    value = `Reference #${readScripTag.index}`;\n                    readScripTag(2);\n                    break;\n                case 8: {\n                    value = Object.create(null);\n                    let lastType = -1;\n                    while (lastType !== 9) {\n                        const nameLength = readBufferSum(readScripTag(2));\n                        const name = readString(readScripTag(nameLength));\n                        const itemType = readScripTag(1)[0];\n                        if (name) {\n                            value[name] = getValue(itemType);\n                        }\n                        lastType = itemType;\n                    }\n                    break;\n                }\n                case 10: {\n                    const valueLength = readBufferSum(readScripTag(4));\n                    value = [];\n                    for (let index = 0; index < valueLength; index += 1) {\n                        const itemType = readScripTag(1)[0];\n                        value.push(getValue(itemType));\n                    }\n                    break;\n                }\n                case 11:\n                    value = readDouble(readScripTag(2));\n                    break;\n                case 12: {\n                    const valueLength = readBufferSum(readScripTag(4));\n                    value = readString(readScripTag(valueLength));\n                    break;\n                }\n                default:\n                    debug.error(false, `AMF: Unknown metaData type: ${type}`);\n                    break;\n            }\n        }\n        return value;\n    }\n\n    while (readScripTag.index < tag.body.length) {\n        const nameLength = readBufferSum(readScripTag(2));\n        const name = readString(readScripTag(nameLength));\n        const type = readScripTag(1)[0];\n        if (name) {\n            amf2.metaData[name] = getValue(type);\n        }\n    }\n\n    debug.warn(readScripTag.index === tag.body.length, '[AMF] Seems to be incompletely parsed');\n    debug.warn(amf2.size === Object.keys(amf2.metaData).length, '[AMF] [amf2] length does not match');\n\n    scripMeta = { amf1, amf2 };\n    postMessage({\n        type: 'scripMeta',\n        data: scripMeta,\n    });\n}\n\nfunction demuxerVideoTag(tag) {\n    debug.error(tag.body.length > 1, 'Invalid video packet');\n    const header = {\n        frameType: (tag.body[0] & 0xf0) >> 4,\n        codecID: tag.body[0] & 0x0f,\n    };\n    debug.error(header.codecID === 7, `[videoTrack] Unsupported codec in video frame: ${header.codecID}`);\n    const packet = tag.body.slice(1, 5);\n    debug.error(packet.length >= 4, '[H264] Invalid AVC packet, missing AVCPacketType or/and CompositionTime');\n    const view = new DataView(packet.buffer);\n    const AVCPacketType = view.getUint8(0);\n    const CompositionTime = ((view.getUint32(0) & 0x00ffffff) << 8) >> 8;\n    const pts = CompositionTime + tag.timestamp;\n    const packetData = tag.body.subarray(5);\n\n    if (AVCPacketType === 0) {\n        debug.warn(!AVCDecoderConfigurationRecord, '[h264] Find another one AVCDecoderConfigurationRecord');\n        debug.error(packetData.length >= 7, '[H264] AVCDecoderConfigurationRecord parse length is not enough');\n        const readDcr = readBuffer(packetData);\n        const result = {};\n        result.configurationVersion = readDcr(1)[0];\n        debug.error(\n            result.configurationVersion === 1,\n            `[H264] Invalid configurationVersion: ${result.configurationVersion}`,\n        );\n        result.AVCProfileIndication = readDcr(1)[0];\n        debug.error(\n            result.AVCProfileIndication !== 0,\n            `[H264] Invalid AVCProfileIndication: ${result.AVCProfileIndication}`,\n        );\n        result.profile_compatibility = readDcr(1)[0];\n        result.AVCLevelIndication = readDcr(1)[0];\n        result.lengthSizeMinusOne = (readDcr(1)[0] & 3) + 1;\n        debug.error(\n            result.lengthSizeMinusOne === 4 || result.lengthSizeMinusOne !== 3,\n            `[H264] Invalid lengthSizeMinusOne: ${result.lengthSizeMinusOne}`,\n        );\n        result.numOfSequenceParameterSets = readDcr(1)[0] & 31;\n        debug.error(\n            result.numOfSequenceParameterSets !== 0,\n            `[H264] Invalid numOfSequenceParameterSets: ${result.numOfSequenceParameterSets}`,\n        );\n        debug.warn(\n            result.numOfSequenceParameterSets === 1,\n            `[H264] Strange numOfSequenceParameterSets: ${result.numOfSequenceParameterSets}`,\n        );\n        for (let index = 0; index < result.numOfSequenceParameterSets; index += 1) {\n            result.sequenceParameterSetLength = readBufferSum(readDcr(2));\n            if (result.sequenceParameterSetLength > 0) {\n                const SPS = readDcr(result.sequenceParameterSetLength);\n                postMessage({\n                    type: 'videoData',\n                    data: mergeBuffer(nalStart, SPS),\n                });\n            }\n        }\n        result.numOfPictureParameterSets = readDcr(1)[0];\n        debug.error(\n            result.numOfPictureParameterSets !== 0,\n            `[H264] Invalid numOfPictureParameterSets: ${result.numOfPictureParameterSets}`,\n        );\n        debug.warn(\n            result.numOfPictureParameterSets === 1,\n            `[H264] Strange numOfPictureParameterSets: ${result.numOfPictureParameterSets}`,\n        );\n        for (let index = 0; index < result.numOfPictureParameterSets; index += 1) {\n            result.pictureParameterSetLength = readBufferSum(readDcr(2));\n            if (result.pictureParameterSetLength > 0) {\n                const PPS = readDcr(result.pictureParameterSetLength);\n                postMessage({\n                    type: 'videoData',\n                    data: mergeBuffer(nalStart, PPS),\n                });\n            }\n        }\n        AVCDecoderConfigurationRecord = result;\n        postMessage({\n            type: 'AVCDecoderConfigurationRecord',\n            data: result,\n        });\n    } else if (AVCPacketType === 1) {\n        const { lengthSizeMinusOne } = AVCDecoderConfigurationRecord;\n        const readVideo = readBuffer(packetData);\n        while (readVideo.index < packetData.length) {\n            const length = readBufferSum(readVideo(lengthSizeMinusOne));\n            postMessage({\n                type: 'videoData',\n                data: mergeBuffer(nalStart, readVideo(length)),\n                timestamp: pts,\n            });\n        }\n    } else {\n        debug.error(AVCPacketType === 2, `[H264] Invalid video packet type ${AVCPacketType}`);\n    }\n}\n\nfunction demuxerAudioTag(tag) {\n    debug.error(tag.body.length > 1, 'Invalid audio packet');\n    const header = {\n        soundFormat: (tag.body[0] & 0xf0) >> 4,\n        soundRate: (tag.body[0] & 0x0c) >> 2,\n        soundSize: (tag.body[0] & 0x02) >> 1,\n        soundType: (tag.body[0] & 0x01) >> 0,\n    };\n    debug.error(header.soundFormat === 10, `[audioTrack] unsupported audio format: ${header.soundFormat}`);\n    const packet = tag.body.subarray(1);\n    const packetType = packet[0];\n    if (packetType === 0) {\n        const packetData = packet.subarray(1);\n        debug.warn(!AudioSpecificConfig, '[AAC] Find another one AudioSpecificConfig');\n        debug.error(packetData.length >= 2, '[AAC] AudioSpecificConfig parse length is not enough');\n        const result = {};\n        result.audioObjectType = (packetData[0] & 0xf8) >> 3;\n        result.samplingFrequencyIndex = ((packetData[0] & 7) << 1) + (((packetData[1] & 0x80) >> 7) & 1);\n        result.channelConfiguration = (packetData[1] & 0x7f) >> 3;\n        AudioSpecificConfig = result;\n        postMessage({\n            type: 'AudioSpecificConfig',\n            data: result,\n        });\n    } else {\n        const { audioObjectType, samplingFrequencyIndex, channelConfiguration } = AudioSpecificConfig;\n        const ADTSLen = tag.dataSize - 2 + 7;\n        const ADTSHeader = new Uint8Array(7);\n        ADTSHeader[0] = 0xff;\n        ADTSHeader[1] = 0xf0;\n        ADTSHeader[1] |= 0 << 3;\n        ADTSHeader[1] |= 0 << 1;\n        ADTSHeader[1] |= 1;\n        ADTSHeader[2] = (audioObjectType - 1) << 6;\n        ADTSHeader[2] |= (samplingFrequencyIndex & 0x0f) << 2;\n        ADTSHeader[2] |= 0 << 1;\n        ADTSHeader[2] |= (channelConfiguration & 0x04) >> 2;\n        ADTSHeader[3] = (channelConfiguration & 0x03) << 6;\n        ADTSHeader[3] |= 0 << 5;\n        ADTSHeader[3] |= 0 << 4;\n        ADTSHeader[3] |= 0 << 3;\n        ADTSHeader[3] |= 0 << 2;\n        ADTSHeader[3] |= (ADTSLen & 0x1800) >> 11;\n        ADTSHeader[4] = (ADTSLen & 0x7f8) >> 3;\n        ADTSHeader[5] = (ADTSLen & 0x7) << 5;\n        ADTSHeader[5] |= 0x1f;\n        ADTSHeader[6] = 0xfc;\n        const ADTSBody = tag.body.subarray(2);\n        postMessage({\n            type: 'audioData',\n            data: mergeBuffer(ADTSHeader, ADTSBody),\n            timestamp: tag.timestamp,\n        });\n    }\n}\n\nonmessage = event => {\n    uint8 = mergeBuffer(uint8, event.data);\n    if (!header && readable(13)) {\n        header = Object.create(null);\n        header.signature = readString(read(3));\n        header.version = read(1)[0];\n        debug.error(header.signature === 'FLV' && header.version === 1, 'FLV header not found');\n        header.flags = read(1)[0];\n        const hasAudio = ((header.flags & 4) >>> 2) !== 0;\n        const hasVideo = (header.flags & 1) !== 0;\n        debug.warn(hasVideo, '[FLV header] flags not found video');\n        debug.warn(hasAudio, '[FLV header] flags not found audio');\n        header.headersize = readBufferSum(read(4));\n        const prevTagSize = readBufferSum(read(4));\n        debug.error(prevTagSize === 0, `PrevTagSize0 should be equal to 0, but got ${prevTagSize}`);\n        postMessage({\n            type: 'flvHeader',\n            data: header,\n        });\n    }\n\n    while (index < uint8.length) {\n        const tag = Object.create(null);\n        const restIndex = index;\n\n        if (readable(11)) {\n            tag.tagType = read(1)[0];\n            tag.dataSize = readBufferSum(read(3));\n            const ts2 = read(1)[0];\n            const ts1 = read(1)[0];\n            const ts0 = read(1)[0];\n            const ts3 = read(1)[0];\n            tag.timestamp = ts0 | (ts1 << 8) | (ts2 << 16) | (ts3 << 24);\n            tag.streamID = readBufferSum(read(3));\n            debug.error(tag.streamID === 0, `streamID should be equal to 0, but got ${tag.streamID}`);\n        } else {\n            index = 0;\n            uint8 = uint8.subarray(restIndex);\n            return;\n        }\n\n        if (readable(tag.dataSize + 4)) {\n            tag.body = read(tag.dataSize);\n            const prevTagSize = readBufferSum(read(4));\n            debug.error(prevTagSize === tag.dataSize + 11, `Invalid PrevTagSize: ${prevTagSize}`);\n        } else {\n            index = 0;\n            uint8 = uint8.subarray(restIndex);\n            return;\n        }\n\n        switch (tag.tagType) {\n            case 18:\n                demuxerScripTag(tag);\n                break;\n            case 9:\n                demuxerVideoTag(tag);\n                break;\n            case 8:\n                demuxerAudioTag(tag);\n                break;\n            default:\n                debug.error(false, `unknown tag type: ${tag.tagType}`);\n                break;\n        }\n    }\n\n    index = 0;\n    uint8 = new Uint8Array();\n};\n"),this.streamRate=A(function(e){r.emit("streamRate",e)}),this.demuxRate=A(function(e){r.emit("demuxRate",e)}),r.on("destroy",function(){i.demuxWorker.terminate()}),r.on("streamStart",function(){if(i.streamStartTime=T(),"string"==typeof n.url){var e=Object.assign(document.createElement("a"),{href:n.url}).href;a.log("stream-url",e)}}),r.on("streaming",function(e){i.streaming=!0,i.size+=e.byteLength,i.streamRate(e.byteLength),i.demuxWorker.postMessage(e)}),r.on("streamEnd",function(e){i.streaming=!1,i.streamEndTime=T(),e&&(i.index=0,i.size=e.byteLength,i.demuxWorker.postMessage(e)),a.log("stream-size","".concat(i.size," byte")),a.log("stream-time","".concat(i.streamEndTime-i.streamStartTime," ms")),i.demuxed=!0,r.emit("demuxDone"),a.log("demux-done")});var o=new Uint8Array,u=new Uint8Array;this.demuxWorker.onmessage=function(e){var n=e.data;switch(n.type){case"flvHeader":i.header=n.data,r.emit("flvHeader",i.header),a.log("flv-header",i.header);break;case"scripMeta":i.scripMeta=n.data,r.emit("scripMeta",i.scripMeta),a.log("scrip-meta",i.scripMeta);break;case"AVCDecoderConfigurationRecord":i.AVCDecoderConfigurationRecord=n.data,r.emit("AVCDecoderConfigurationRecord",i.AVCDecoderConfigurationRecord),a.log("AVCDecoderConfigurationRecord",i.AVCDecoderConfigurationRecord),a.log("AVC-profile",function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}(i.AVCDecoderConfigurationRecord.AVCProfileIndication)),a.log("AVC-level",function(e){return(e/10).toFixed(1)}(i.AVCDecoderConfigurationRecord.AVCLevelIndication));break;case"AudioSpecificConfig":i.AudioSpecificConfig=n.data,r.emit("AudioSpecificConfig",i.AudioSpecificConfig),a.log("AudioSpecificConfig",i.AudioSpecificConfig);break;case"videoData":i.demuxRate(1),i.videoDataLength+=1,i.videoDataSize+=n.data.byteLength;var t=v(n.data);switch(t(4),31&t(1)[0]){case 1:case 5:r.emit("videoData",b(o,u,n.data),n.timestamp);break;case 7:o=n.data;break;case 8:u=n.data}break;case"audioData":i.audioDataLength+=1,i.audioDataSize+=n.data.byteLength,r.emit("audioData",n.data,n.timestamp)}}}function M(i,n){return i.emit("streamStart"),fetch(i.options.url,{headers:i.options.headers}).then(function(e){var n=e.body.getReader();return i.on("streamCancel",function(){n.cancel()}),function r(){return n.read().then(function(e){var n=e.done,t=e.value;if(!n)return i.emit("streaming",new Uint8Array(t)),r();i.emit("streamEnd")}).catch(function(e){throw e})}()}).catch(function(e){throw n.reconnect(e),e})}function V(e,n){e.emit("streamStart");var t=e.events.proxy,r=e.options.headers,i=new XMLHttpRequest;return i.open("GET",e.options.url,!0),i.responseType="moz-chunked-arraybuffer",Object.keys(r).forEach(function(e){i.setRequestHeader(e,r[e])}),t(i,"readystatechange",function(){e.emit("readystatechange",i)}),t(i,"progress",function(){e.emit("streaming",new Uint8Array(i.response))}),t(i,"loadend",function(){e.emit("streamEnd")}),t(i,"error",function(e){throw n.reconnect(e),e}),i.send(),e.on("streamCancel",function(){i.abort()}),i}function F(n,t){n.emit("streamStart");var e=n.events.proxy,r=n.options.headers,i=new TextEncoder,a=new XMLHttpRequest;a.open("GET",n.options.url,!0),a.responseType="text",Object.keys(r).forEach(function(e){a.setRequestHeader(e,r[e])});var o=0;return e(a,"readystatechange",function(){n.emit("readystatechange",a)}),e(a,"progress",function(){var e=a.responseText.substr(o);o=a.responseText.length,n.emit("streaming",i.encode(e,{stream:!0}))}),e(a,"loadend",function(){n.emit("streaming",i.encode("",{stream:!1})),n.emit("streamEnd")}),e(a,"error",function(e){throw t.reconnect(e),e}),a.send(),n.on("streamCancel",function(){a.abort()}),a}function R(n,t){n.emit("streamStart");var e=n.options,r=n.events.proxy,i=new WebSocket(n.options.url);return i.binaryType="arraybuffer",r(i,"open",function(){i.send(e.socketSend)}),r(i,"message",function(e){n.emit("streaming",new Uint8Array(e.data))}),r(i,"close",function(){n.emit("streamEnd")}),r(i,"error",function(e){throw t.reconnect(e),e}),n.on("streamCancel",function(){i.close()}),i}function H(t){t.emit("streamStart");var e=t.events.proxy,n=new FileReader;return e(n,"load",function(e){var n=e.target.result;t.emit("streamEnd",new Uint8Array(n))}),n.readAsArrayBuffer(t.options.url),n}var z=function(){function t(e){var n=this;c(this,t),this.flv=e,this.reconnectTime=0,this.maxReconnectTime=10,this.transportFactory=t.getStreamFactory(e.options.url),this.flv.debug.log("stream-type",this.transportFactory.name),this.transport=this.transportFactory(e,this),e.on("destroy",function(){n.flv.emit("streamCancel")}),e.on("reconnect",function(){n.reconnect()})}return n(t,[{key:"reconnect",value:function(){var e=this;this.reconnectTime<this.maxReconnectTime&&!this.flv.isDestroy&&this.flv.options.live&&setTimeout(function(){e.reconnectTime+=1,e.flv.emit("streamCancel"),e.transport=e.transportFactory(e.flv,e),e.flv.debug.warn(!1,"[stream]: reconnect ".concat(e.reconnectTime)),e.flv.emit("streamReconnect")},1e3)}}],[{key:"supportsXhrResponseType",value:function(e){try{var n=new XMLHttpRequest;return n.responseType=e,n.responseType===e}catch(e){return!1}}},{key:"getStreamFactory",value:function(e){if(e instanceof File)return H;if(e.startsWith("ws://"))return R;if("undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers)return M;return t.supportsXhrResponseType("moz-chunked-arraybuffer")?V:F}}]),t}();function U(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,r)}return t}var I=0,q=function(){function t(e){var n;return c(this,t),(n=o(this,u(t).call(this))).options=function(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?U(t,!0).forEach(function(e){r(n,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):U(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}return n}({},t.options,{},e),n.options.live&&(n.options.cache=!1,n.options.hasAudio=!1),"string"==typeof n.options.container&&(n.options.container=document.querySelector(n.options.container)),window.FlvplayerDecoder?n.init():x(n.options.decoder,"FlvplayerDecoder").then(function(){n.init()}),console.log("%c FlvPlayer.js %c 1.0.9 %c https://flvplayer.js.org","color: #fff; background: #5f5f5f","color: #fff; background: #4bc729",""),n}return d(t,f),n(t,[{key:"init",value:function(){this.isDestroy=!1,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.debug=new l(this),this.events=new g(this),this.player=new O(this),this.decoder=new B(this),this.demuxer=new E(this),this.stream=new z(this),window.FlvplayerControl&&this.options.control&&(this.control=new window.FlvplayerControl(this)),I+=1,this.id=I,t.instances.push(this)}},{key:"destroy",value:function(){this.isDestroy=!0,this.emit("destroy"),t.instances.splice(t.instances.indexOf(this),1)}}],[{key:"options",get:function(){return{url:"",container:"",debug:!1,live:!1,loop:!1,autoPlay:!1,hasAudio:!0,control:!0,cache:!0,muted:!1,volume:7,frameRate:30,maxTimeDiff:200,freeMemory:67108864,width:400,height:300,socketSend:"",headers:{},decoder:"./flvplayer-decoder-baseline.js"}}},{key:"version",get:function(){return"1.0.9"}},{key:"env",get:function(){return'"production"'}},{key:"utils",get:function(){return k}},{key:"Emitter",get:function(){return f}}]),t}();return Object.defineProperty(q,"instances",{value:[]}),q});
